<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta property="fc:frame" content="vNext">
    <meta property="fc:frame:image" content="https://farmeow.vercel.app/og-image.png">
    <meta property="og:image" content="https://farmeow.vercel.app/og-image.png">
    <meta property="og:title" content="Far Meow - Cat Running Game">
    <meta property="og:description" content="Compete for hourly USDC prizes! üê±‚ö°">
    <meta property="fc:frame:button:1" content="Play Far Meow üê±">
    <meta property="fc:frame:button:1:action" content="link">
    <meta property="fc:frame:button:1:target" content="https://farmeow.vercel.app">
    <title>Far Meow: Cat Running Game üê±‚ö°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <!-- Neynar Mini App SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@neynar/nodejs-sdk@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #050510;
            font-family: 'Nunito', sans-serif;
            touch-action: none;
            -webkit-font-smoothing: antialiased;
        }
        
        canvas { display: block; }
        .game-font { font-family: 'Fredoka One', cursive; }

        /* UI Screens */
        .ui-screen {
            transition: opacity 0.3s ease;
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
        }
        
        .hidden-screen {
            opacity: 0;
            pointer-events: none;
        }

        .active-screen {
            opacity: 1;
            pointer-events: auto;
        }

        /* HUD */
        .hud-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }
        .animate-float { animation: float 3s ease-in-out infinite; }

        .glass-panel {
            background: rgba(10, 10, 20, 0.8);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(56, 189, 248, 0.3); /* Light Blue Border */
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.1);
            border-radius: 16px;
        }
        
        .neon-text {
            text-shadow: 0 0 10px rgba(56, 189, 248, 0.6);
        }

        /* LEADERBOARD STYLES */
        .leaderboard-container {
            max-height: 400px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(56, 189, 248, 0.3) transparent;
        }
        
        .leaderboard-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .leaderboard-container::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .leaderboard-container::-webkit-scrollbar-thumb {
            background: rgba(56, 189, 248, 0.3);
            border-radius: 3px;
        }
        
        .leaderboard-row {
            transition: background-color 0.2s ease;
        }
        
        .leaderboard-row:hover {
            background: rgba(56, 189, 248, 0.1);
        }
        
        .rank-badge {
            min-width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .rank-1 { background: linear-gradient(135deg, #ffd700, #ffed4e); color: #000; }
        .rank-2 { background: linear-gradient(135deg, #c0c0c0, #e8e8e8); color: #000; }
        .rank-3 { background: linear-gradient(135deg, #cd7f32, #e89b5c); color: #000; }
        .rank-other { background: rgba(56, 189, 248, 0.2); color: #67e8f9; }
    </style>
</head>
<body class="text-white select-none bg-gray-900">

    <!-- Header -->
    <div class="absolute top-0 left-0 w-full h-12 bg-gray-900/90 border-b border-cyan-900/50 z-50 flex items-center px-4 justify-between text-xs text-cyan-400">
        <div class="flex items-center gap-2">
            <div class="w-4 h-4 rounded-full bg-cyan-500 shadow-[0_0_10px_rgba(6,182,212,0.6)]"></div>
            <span id="farcasterStatus">CONNECTING...</span>
        </div>
        <div><span id="walletBalance">-- USDC</span></div>
    </div>

    <canvas id="gameCanvas" class="mt-12"></canvas>

    <!-- 1. LANDING SCREEN -->
    <div id="landingScreen" class="ui-screen active-screen pt-12">
        <div class="absolute top-16 bg-cyan-900/20 border border-cyan-500/50 px-4 py-1 rounded-full flex items-center gap-2">
            <span class="text-xs text-cyan-300 font-bold uppercase">ENDS IN</span>
            <span id="countDown" class="font-mono font-bold text-cyan-100">59:21</span>
        </div>

        <div class="text-center animate-float mt-8">
            <h1 class="text-5xl game-font text-transparent bg-clip-text bg-gradient-to-b from-cyan-300 to-blue-500 neon-text tracking-wide">FAR<br>MEOW</h1>
            <p class="text-cyan-300 font-bold mt-2 tracking-widest text-xs">FARCASTER EDITION</p>
        </div>

        <div class="mt-8 glass-panel p-6 w-11/12 max-w-sm text-center">
            <p class="text-cyan-400 text-xs font-bold uppercase tracking-widest mb-1">HOURLY JACKPOT</p>
            <p class="text-5xl game-font text-white neon-text">$<span id="potValue">1,240</span></p>
            
            <div class="grid grid-cols-3 gap-2 text-center text-xs border-t border-cyan-800/50 pt-4 mt-4">
                <div><div class="text-cyan-500">1ST</div><div class="text-white font-bold">$310</div></div>
                <div><div class="text-cyan-500">TOP 10</div><div class="text-white font-bold">>$55</div></div>
                <div><div class="text-cyan-500">TOP 20</div><div class="text-white font-bold">>$22</div></div>
            </div>
        </div>
        
        <div class="mt-8 w-full px-6 max-w-sm">
            <button onclick="initiatePayment()" class="w-full py-4 rounded-xl font-black text-xl bg-gradient-to-r from-cyan-500 to-blue-600 text-white game-font shadow-[0_0_20px_rgba(6,182,212,0.4)] active:scale-95 transition-transform">
                PLAY NOW <span class="text-sm opacity-80 ml-2">(0.25 USDC)</span>
            </button>
            <p class="text-cyan-400 text-xs mt-2 text-center">Top 20 split $<span id="potValueSmall">--</span> hourly</p>
        </div>

        <!-- LEADERBOARD SECTION -->
        <div class="mt-6 glass-panel p-4 w-11/12 max-w-sm">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-cyan-400 font-bold text-sm uppercase tracking-widest">Top 100 Players</h3>
                <button onclick="refreshLeaderboard()" class="text-cyan-500 text-xs hover:text-cyan-300">
                    <span id="refreshIcon">üîÑ</span>
                </button>
            </div>
            
            <div class="leaderboard-container">
                <div id="leaderboardList" class="space-y-1">
                    <div class="text-center py-8 text-cyan-400 text-sm">
                        Loading leaderboard...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. PAYMENT SCREEN -->
    <div id="paymentScreen" class="ui-screen hidden-screen glass-panel z-30 bg-black/90">
        <div class="text-center">
            <div class="w-12 h-12 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <h3 class="text-sm text-white">PROCESSING...</h3>
        </div>
    </div>

    <!-- 3. HUD -->
    <div id="hud" class="hud-layer hidden-screen pt-12">
        <div class="absolute top-16 left-4 right-4 flex justify-between items-start">
            <div class="bg-gray-900/60 backdrop-blur px-4 py-2 rounded-full border border-cyan-500/30 flex items-center gap-2">
                <span class="text-xl">üí†</span>
                <span id="scoreDisplay" class="text-xl font-bold text-white game-font">0</span>
            </div>
            <div class="bg-gray-900/60 backdrop-blur px-4 py-2 rounded-full border border-cyan-500/30 text-right">
                <span class="text-cyan-300 text-xs font-bold uppercase">RANK</span>
                <span id="liveRank" class="text-green-400 font-bold game-font ml-2">--</span>
            </div>
        </div>
        <div class="absolute bottom-8 w-full text-center">
             <p class="text-cyan-200/50 text-xs font-bold animate-pulse">TAP TO JUMP</p>
        </div>
    </div>

    <!-- 4. GAME OVER -->
    <div id="gameOverScreen" class="ui-screen hidden-screen z-30 pt-12 bg-black/80 backdrop-blur">
        <div class="glass-panel p-8 rounded-3xl text-center max-w-xs w-full">
            <h2 class="text-3xl text-white game-font mb-1 neon-text">Finished!</h2>
            
            <div class="bg-gray-900/50 rounded-xl p-4 mb-6 border border-cyan-900/50">
                <div class="flex justify-between items-end mb-2 border-b border-cyan-900/50 pb-2">
                    <span class="text-cyan-400 text-sm">SCORE</span>
                    <span id="finalScore" class="text-xl text-white font-bold">0</span>
                </div>
                <div class="flex justify-between items-end">
                    <span class="text-yellow-500 text-sm font-bold">PAYOUT</span>
                    <span id="estPayout" class="text-xl text-yellow-400 font-bold">$23.40</span>
                </div>
            </div>
            
            <button onclick="initiatePayment()" class="w-full py-3 bg-cyan-600 hover:bg-cyan-500 text-white rounded-xl font-bold text-lg mb-3 shadow-lg transition-colors">RETRY</button>
            <button onclick="shareResult()" class="w-full py-3 border border-cyan-700 text-cyan-300 rounded-xl font-bold text-sm hover:bg-cyan-900/30 transition-colors">Share Result</button>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIG & GLOBALS
        // ============================================
        
        const CONFIG = {
            VAULT_CONTRACT: '0xaf08c8f5100Afd8aE30f40751ED85B125b873f77',
            USDC_ADDRESS: '0x036CbD53842c5426634e7929541eC2318f3dCF7e',
            BASE_CHAIN_ID: 84532,
            ENTRY_FEE: '250000',
            API_ENDPOINT: 'https://api.far-meow.app',
            NEYNAR_CLIENT_ID: 'YOUR_NEYNAR_CLIENT_ID', // Get from https://dev.neynar.com
            MAX_SCORE: 999999,
            MIN_GAME_DURATION: 5000
        };

        let ethersProvider = null;
        let currentUser = null;
        let vaultContract = null;
        let usdcContract = null;
        let currentPot = 0;
        let currentRoundId = null;
        let gameStartTime = null;
        let isProcessingPayment = false;
        let countdownInterval = null;
        let score = 0;
        let neynarUser = null;

        const VAULT_ABI = [
            "function payEntry() external",
            "function commitScore(bytes32) external",
            "function getCurrentRound() view returns (uint256, uint256, uint256, uint256, bool)",
            "function getPlayerScore(address) view returns (uint256)",
            "function getTopPlayers(uint256) view returns (address[],uint256[])",
            "function estimatePayout(uint256) view returns (uint256)"
        ];

        const ERC20_ABI = [
            "function balanceOf(address) view returns (uint256)",
            "function approve(address spender, uint256 amount) external returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)"
        ];

        // ============================================
        // NEYNAR MINI APP AUTH + METAMASK
        // ============================================

        async function initApp() {
            console.log('üöÄ Initializing Far Meow...');

            if (typeof ethers === 'undefined') {
                console.error('‚ùå Ethers.js not loaded');
                document.getElementById('farcasterStatus').textContent = 'LOAD ERROR';
                return;
            }

            // Try to load Neynar user from localStorage (persisted from previous auth)
            const savedUser = localStorage.getItem('neynarUser');
            if (savedUser) {
                try {
                    neynarUser = JSON.parse(savedUser);
                    console.log('‚úÖ Loaded saved Neynar user:', neynarUser.username);
                    currentUser = {
                        address: null, // Will be set when wallet connects
                        username: neynarUser.username,
                        fid: neynarUser.fid,
                        signer: neynarUser.signer
                    };
                } catch (e) {
                    console.warn('Could not parse saved user', e);
                    localStorage.removeItem('neynarUser');
                }
            }

            // Show auth options
            showAuthOptions();
        }

        function showAuthOptions() {
            const statusEl = document.getElementById('farcasterStatus');
            
            if (currentUser?.fid) {
                // Already have Farcaster user, just need wallet
                statusEl.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span>@${currentUser.username}</span>
                        <button onclick="connectMetaMask()" class="px-2 py-1 bg-cyan-600 hover:bg-cyan-500 rounded text-white font-bold text-xs">WALLET</button>
                    </div>
                `;
            } else {
                // Show both options
                statusEl.innerHTML = `
                    <div class="flex items-center gap-2">
                        <button onclick="authenticateNeynar()" class="px-3 py-1 bg-purple-600 hover:bg-purple-500 rounded text-white font-bold text-xs">FARCASTER</button>
                        <button onclick="connectMetaMask()" class="px-3 py-1 bg-cyan-600 hover:bg-cyan-500 rounded text-white font-bold text-xs">WALLET</button>
                    </div>
                `;
            }
        }

        // ============================================
        // NEYNAR MINI APP AUTHENTICATION
        // ============================================

        async function authenticateNeynar() {
            try {
                console.log('üì± Opening Neynar Mini App Auth...');
                
                if (!CONFIG.NEYNAR_CLIENT_ID || CONFIG.NEYNAR_CLIENT_ID === 'YOUR_NEYNAR_CLIENT_ID') {
                    alert('Neynar client ID not configured');
                    return;
                }

                // Call backend to initiate auth flow
                const response = await fetch(`${CONFIG.API_ENDPOINT}/neynar/auth-url`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        clientId: CONFIG.NEYNAR_CLIENT_ID,
                        redirectUrl: window.location.href
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to get auth URL');
                }

                const { authUrl } = await response.json();
                console.log('üîó Redirecting to Neynar auth...');
                
                // Redirect to Neynar auth
                window.location.href = authUrl;

            } catch (error) {
                console.error('‚ùå Neynar auth failed:', error);
                alert(`Auth failed: ${error.message}`);
            }
        }

        // Handle Neynar callback
        async function handleNeynarCallback() {
            console.log('üîÑ Processing Neynar callback...');

            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            const state = params.get('state');

            if (!code) {
                console.log('No auth code in URL');
                return;
            }

            try {
                // Exchange code for token with backend
                const response = await fetch(`${CONFIG.API_ENDPOINT}/neynar/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, state })
                });

                if (!response.ok) {
                    throw new Error('Token exchange failed');
                }

                const { user } = await response.json();
                console.log('‚úÖ Neynar auth successful:', user);

                neynarUser = user;
                currentUser = {
                    address: null,
                    username: user.username,
                    fid: user.fid,
                    signer: user.signer
                };

                // Save to localStorage
                localStorage.setItem('neynarUser', JSON.stringify(neynarUser));

                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);

                // Now connect wallet
                showAuthOptions();
                console.log('‚úÖ Ready to connect wallet');

            } catch (error) {
                console.error('‚ùå Callback processing failed:', error);
                alert(`Callback error: ${error.message}`);
            }
        }

        // ============================================
        // METAMASK WALLET CONNECTION
        // ============================================

        async function connectMetaMask() {
            try {
                console.log('üîÑ Connecting MetaMask...');

                if (!window.ethereum) {
                    alert('MetaMask required: https://metamask.io/download/');
                    return;
                }

                // Request accounts
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });

                if (!accounts?.length) {
                    throw new Error('No accounts returned');
                }

                const address = accounts[0];
                console.log('‚úÖ Connected:', address);

                // Update user
                if (!currentUser) {
                    currentUser = {
                        address,
                        username: `${address.slice(0, 6)}...${address.slice(-4)}`
                    };
                } else {
                    currentUser.address = address;
                }

                document.getElementById('farcasterStatus').textContent = 
                    currentUser.fid ? `@${currentUser.username}` : currentUser.username;

                // Create provider
                ethersProvider = new ethers.providers.Web3Provider(window.ethereum);

                // Check/switch network
                const network = await ethersProvider.getNetwork();
                console.log('üì° Chain ID:', network.chainId);

                if (network.chainId !== CONFIG.BASE_CHAIN_ID) {
                    await switchNetwork();
                }

                // Initialize contracts
                const signer = ethersProvider.getSigner();
                vaultContract = new ethers.Contract(CONFIG.VAULT_CONTRACT, VAULT_ABI, signer);
                usdcContract = new ethers.Contract(CONFIG.USDC_ADDRESS, ERC20_ABI, signer);

                console.log('‚úÖ Contracts initialized');

                // Load data
                await loadVaultData();
                await updateBalance();
                await loadLeaderboard();

                // Polling
                setInterval(loadVaultData, 10000);
                setInterval(updateBalance, 30000);
                setInterval(loadLeaderboard, 15000);

                console.log('‚úÖ Ready to play!');

            } catch (error) {
                console.error('‚ùå MetaMask connection failed:', error);
                alert(`Error: ${error.message}`);
                showAuthOptions();
            }
        }

        async function switchNetwork() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0x14a34' }]
                });
                console.log('‚úÖ Network switched');
            } catch (switchError) {
                if (switchError.code === 4902) {
                    console.log('üì¶ Adding Base Sepolia...');
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: '0x14a34',
                            chainName: 'Base Sepolia',
                            nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                            rpcUrls: ['https://sepolia.base.org'],
                            blockExplorerUrls: ['https://sepolia.basescan.org']
                        }]
                    });
                } else {
                    throw switchError;
                }
            }
        }

        // ============================================
        // ON-CHAIN DATA LOADING
        // ============================================

        async function loadVaultData() {
            if (!vaultContract) return;
            try {
                const roundData = await vaultContract.getCurrentRound();
                currentRoundId = roundData[0].toNumber();
                const vaultAmount = ethers.utils.formatUnits(roundData[1], 6);
                const timeRemaining = roundData[3].toNumber();
                currentPot = parseFloat(vaultAmount) || 0;
                const potDisplay = Math.floor(currentPot).toLocaleString();
                document.getElementById('potValue').textContent = potDisplay;
                document.getElementById('potValueSmall').textContent = potDisplay;
                startCountdown(timeRemaining);
                updatePayoutEstimates(currentPot);
                console.log('‚úÖ Vault data loaded');
            } catch (error) {
                console.error('‚ùå loadVaultData failed:', error);
            }
        }

        async function updateBalance() {
            if (!usdcContract || !ethersProvider) return;
            try {
                const signer = ethersProvider.getSigner();
                const address = await signer.getAddress();
                const balance = await usdcContract.balanceOf(address);
                const formatted = ethers.utils.formatUnits(balance, 6);
                const num = parseFloat(formatted) || 0;
                document.getElementById('walletBalance').textContent = `${num.toFixed(2)} USDC`;
            } catch (error) {
                console.error('‚ùå updateBalance failed:', error);
            }
        }

        async function loadLeaderboard() {
            if (!CONFIG.API_ENDPOINT) {
                document.getElementById('leaderboardList').innerHTML = 
                    '<div class="text-center py-8 text-cyan-400 text-sm">API not configured</div>';
                return;
            }
            try {
                const response = await fetch(`${CONFIG.API_ENDPOINT}/leaderboard?limit=20`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                renderLeaderboard(Array.isArray(data.players) ? data.players : []);
            } catch (error) {
                console.error('‚ùå loadLeaderboard failed:', error);
                document.getElementById('leaderboardList').innerHTML = 
                    '<div class="text-center py-8 text-yellow-400 text-sm">Backend offline</div>';
            }
        }

        function renderLeaderboard(players) {
            const container = document.getElementById('leaderboardList');
            if (!players?.length) {
                container.innerHTML = '<div class="text-center py-8 text-cyan-400 text-sm">No players yet</div>';
                return;
            }
            let html = '';
            players.slice(0, 20).forEach((player, i) => {
                const rank = i + 1;
                const rankClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : rank === 3 ? 'rank-3' : 'rank-other';
                const score = Number(player.score) || 0;
                const payout = Number(player.estimatedPayout) || 0;
                const name = (player.username || 'Player').replace(/[<>]/g, '');
                html += `
                    <div class="leaderboard-row flex items-center justify-between p-2 rounded-lg">
                        <div class="flex items-center gap-3 flex-1 min-w-0">
                            <div class="rank-badge ${rankClass} text-xs flex-shrink-0">${rank}</div>
                            <div class="flex-1 min-w-0">
                                <div class="text-white font-bold text-sm truncate">${name}</div>
                                <div class="text-cyan-400 text-xs">${score.toLocaleString()} pts</div>
                            </div>
                        </div>
                        <div class="text-yellow-400 font-bold text-sm">$${payout.toFixed(2)}</div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function startCountdown(seconds) {
            if (countdownInterval) clearInterval(countdownInterval);
            let remaining = Math.max(seconds, 0);
            const update = () => {
                const m = Math.floor(remaining / 60);
                const s = remaining % 60;
                document.getElementById('countDown').textContent =
                    `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                remaining--;
                if (remaining < 0) clearInterval(countdownInterval);
            };
            update();
            countdownInterval = setInterval(update, 1000);
        }

        function updatePayoutEstimates(vault) {
            const v = parseFloat(vault) || 0;
            const elems = document.querySelectorAll('.grid .text-white.font-bold');
            if (elems.length >= 3) {
                elems[0].textContent = `$${Math.floor(v * 0.255)}`;
                elems[1].textContent = `$${Math.floor(v * 0.025)}`;
                elems[2].textContent = `$${Math.floor(v * 0.025)}`;
            }
        }

        // ============================================
        // GAME PAYMENT
        // ============================================

        async function initiatePayment() {
            if (isProcessingPayment) return;
            if (!ethersProvider || !vaultContract || !usdcContract) {
                alert('Connect wallet first');
                return;
            }
            if (!currentRoundId) {
                alert('No active round');
                return;
            }
            isProcessingPayment = true;
            document.getElementById('landingScreen').classList.remove('active-screen');
            document.getElementById('landingScreen').classList.add('hidden-screen');
            const payScreen = document.getElementById('paymentScreen');
            payScreen.classList.remove('hidden-screen');
            payScreen.classList.add('active-screen');
            try {
                const signer = ethersProvider.getSigner();
                const address = await signer.getAddress();
                const balance = await usdcContract.balanceOf(address);
                if (balance.lt(CONFIG.ENTRY_FEE)) {
                    throw new Error('Insufficient USDC (need 0.25)');
                }
                const allowance = await usdcContract.allowance(address, CONFIG.VAULT_CONTRACT);
                if (allowance.lt(CONFIG.ENTRY_FEE)) {
                    const approveTx = await usdcContract.approve(
                        CONFIG.VAULT_CONTRACT,
                        ethers.utils.parseUnits('100', 6)
                    );
                    await approveTx.wait(1);
                }
                const tx = await vaultContract.payEntry();
                const receipt = await tx.wait(1);
                if (receipt.status !== 1) throw new Error('Transaction failed');
                await updateBalance();
                setTimeout(() => {
                    payScreen.classList.remove('active-screen');
                    payScreen.classList.add('hidden-screen');
                    isProcessingPayment = false;
                    startGame();
                }, 500);
            } catch (error) {
                alert(`Payment failed: ${error.message}`);
                payScreen.classList.remove('active-screen');
                payScreen.classList.add('hidden-screen');
                document.getElementById('landingScreen').classList.add('active-screen');
                document.getElementById('landingScreen').classList.remove('hidden-screen');
                isProcessingPayment = false;
            }
        }

        // ============================================
        // GAME ENGINE (minimal stub)
        // ============================================

        function startGame() {
            score = 0;
            gameStartTime = Date.now();
            document.getElementById('hud').classList.remove('hidden-screen');
            console.log('üéÆ Game started');
        }

        function gameOver() {
            document.getElementById('hud').classList.add('hidden-screen');
            document.getElementById('finalScore').textContent = score;
            document.getElementById('estPayout').textContent = '$0.00';
            document.getElementById('gameOverScreen').classList.remove('hidden-screen');
            document.getElementById('gameOverScreen').classList.add('active-screen');
            console.log('üèÅ Game over. Score:', score);
        }

        function shareResult() {
            const text = `Scored ${score} in Far Meow! üê±‚ö°`;
            const url = `https://warpcast.com/~/compose?text=${encodeURIComponent(text)}&embeds%5B%5D=https://farmeow.vercel.app`;
            window.open(url, '_blank');
        }

        function refreshLeaderboard() {
            const icon = document.getElementById('refreshIcon');
            icon.style.transform = 'rotate(360deg)';
            icon.style.transition = 'transform 0.5s ease';
            loadLeaderboard();
            setTimeout(() => { icon.style.transform = 'rotate(0deg)'; }, 500);
        }

        // ============================================
        // INIT
        // ============================================

        window.addEventListener('load', () => {
            console.log('üöÄ App loading...');
            // Check if this is a callback from Neynar
            if (window.location.search.includes('code=')) {
                handleNeynarCallback();
            } else {
                initApp();
            }
        });

        window.addEventListener('beforeunload', () => {
            if (countdownInterval) clearInterval(countdownInterval);
        });
    </script>
</body>
</html>